<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <title>JSON to CSV Converter</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            background-color: #f4f6f8;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            margin: 0;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 0 15px rgba(0,0,0,0.1);
            width: 600px;
            text-align: center;
        }
        .drop-zone {
            border: 2px dashed #007bff;
            padding: 30px;
            border-radius: 8px;
            color: #007bff;
            margin-bottom: 20px;
            cursor: pointer;
            user-select: none;
            transition: background-color 0.3s;
        }
        .drop-zone:hover {
            background-color: #e6f0ff;
        }
        .btn {
            padding: 10px 20px;
            margin: 10px 5px;
            border: none;
            border-radius: 5px;
            font-size: 16px;
            cursor: pointer;
            user-select: none;
            transition: background-color 0.3s;
        }
        .btn.primary {
            background-color: #007bff;
            color: white;
        }
        .btn.primary:hover {
            background-color: #0056b3;
        }
        .btn.danger {
            background-color: #dc3545;
            color: white;
        }
        .btn.danger:hover {
            background-color: #a71d2a;
        }
        table {
            width: 100%;
            margin-top: 20px;
            border-collapse: collapse;
            font-size: 14px;
        }
        th, td {
            padding: 8px;
            border: 1px solid #ddd;
            text-align: left;
        }
        th {
            background-color: #007bff;
            color: white;
        }
    </style>
</head>
<body>
    <div class="container">
        <h2>ðŸ“„ JSON to CSV Converter</h2>
        <div class="drop-zone" id="dropZone">Drop or browse your JSON file here</div>
        <input type="file" id="fileInput" style="display:none" accept=".json" />
        <br />
        <button class="btn primary" onclick="showCategoryStats()">Show Category Stats</button>
        <button class="btn primary" onclick="downloadCSV()">Convert & Download CSV</button>
        <button class="btn danger" onclick="removeFile()">Remove File</button>
        <div id="output"></div>
    </div>

    <script>
        let jsonData = null;
        const dropZone = document.getElementById('dropZone');
        const fileInput = document.getElementById('fileInput');
        const outputDiv = document.getElementById('output');

        dropZone.addEventListener('click', () => fileInput.click());
        dropZone.addEventListener('dragover', (e) => {
            e.preventDefault();
            dropZone.style.backgroundColor = '#e0e0e0';
        });
        dropZone.addEventListener('dragleave', () => {
            dropZone.style.backgroundColor = 'white';
        });
        dropZone.addEventListener('drop', (e) => {
            e.preventDefault();
            dropZone.style.backgroundColor = 'white';
            const file = e.dataTransfer.files[0];
            readFile(file);
        });
        fileInput.addEventListener('change', (e) => {
            const file = e.target.files[0];
            readFile(file);
        });

        function readFile(file) {
            if (!file) return;
            const reader = new FileReader();
            reader.onload = () => {
                try {
                    jsonData = JSON.parse(reader.result);
                    console.log('JSON loaded:', jsonData);
                    dropZone.innerText = `Loaded: ${file.name}`;
                    outputDiv.innerHTML = '';
                } catch (e) {
                    alert('Invalid JSON file. Please upload a valid JSON.');
                    dropZone.innerText = 'Drop or browse your JSON file here';
                    jsonData = null;
                    outputDiv.innerHTML = '';
                }
            };
            reader.readAsText(file);
        }

        function getRestaurantData() {
            // Check for the "data" and "restaurants" array and return the first restaurant's details
            if (jsonData && jsonData.data && Array.isArray(jsonData.data.restaurants) && jsonData.data.restaurants.length > 0) {
                return jsonData.data.restaurants[0].details;
            }
            return null;
        }

        function getCategories() {
            if (jsonData && jsonData.data && Array.isArray(jsonData.data.categories)) {
                return jsonData.data.categories;
            }
            return [];
        }

        function getItems() {
            if (jsonData && jsonData.data && Array.isArray(jsonData.data.items)) {
                return jsonData.data.items;
            }
            return [];
        }

        function getVariations() {
            if (jsonData && jsonData.data && Array.isArray(jsonData.data.variations)) {
                return jsonData.data.variations;
            }
            return [];
        }

        function getAddonGroups() {
            if (jsonData && jsonData.data && Array.isArray(jsonData.data.addongroups)) {
                return jsonData.data.addongroups;
            }
            return [];
        }

        function showCategoryStats() {
            if (!jsonData) {
                alert('Upload a file first');
                return;
            }

            const categories = getCategories();
            const items = getItems();

            if (!categories.length) {
                alert('No categories found in JSON');
                return;
            }

            // Create a map to store item counts per category
            const categoryItemCounts = new Map();
            categories.forEach(cat => {
                categoryItemCounts.set(cat.categoryid, { name: cat.categoryname, count: 0 });
            });

            // Count items per category
            items.forEach(item => {
                const categoryId = item.item_categoryid;
                if (categoryItemCounts.has(categoryId)) {
                    categoryItemCounts.get(categoryId).count++;
                }
            });

            let html = `<table>
                            <tr>
                                <th>Category</th>
                                <th>Item Count</th>
                            </tr>`;
            let total = 0;

            categoryItemCounts.forEach((data) => {
                html += `<tr><td>${data.name}</td><td>${data.count}</td></tr>`;
                total += data.count;
            });

            html += `<tr><th>Total</th><th>${total}</th></tr></table>`;
            outputDiv.innerHTML = html;
        }

        function downloadCSV() {
            if (!jsonData) {
                alert('Upload a file first');
                return;
            }

            const restaurantDetails = getRestaurantData();
            const restaurantName = restaurantDetails ? restaurantDetails.restaurantname : 'N/A';

            const categories = getCategories();
            const items = getItems();
            const variations = getVariations();
            const addongroups = getAddonGroups();

            if (!items.length) {
                alert('No items found to export.');
                return;
            }

            // Create maps for quick lookups
            const categoryMap = new Map();
            categories.forEach(cat => {
                categoryMap.set(cat.categoryid, cat.categoryname);
            });

            const variationMap = new Map();
            variations.forEach(v => {
                variationMap.set(v.variationid, v);
            });

            const addongroupMap = new Map();
            addongroups.forEach(group => {
                addongroupMap.set(group.addongroupid, group);
            });

            const rows = [
                ["Restaurant Name", "Category", "Sub-Category", "Item ID", "Item Name", "Item Description", "Item Price", "Item Stock", "Item Status", "Item Image URL",
                 "Variation Group Name", "Variation/Addon ID", "Variation/Addon Name", "Variation/Addon Price", "Variation/Addon Status",
                 "Addon Group Name", "Addon Min Selection", "Addon Max Selection"]
            ];

            items.forEach(item => {
                const categoryName = categoryMap.get(item.item_categoryid) || 'N/A';
                const subCategoryName = categoryName; // As per instruction, if no subcategory, category is subcategory

                // Main item row
                rows.push([
                    restaurantName,
                    categoryName,
                    subCategoryName,
                    item.itemid,
                    item.itemname,
                    item.itemdescription ? item.itemdescription.replace(/"/g, '""') : '', // Escape double quotes
                    item.price,
                    item.in_stock,
                    item.active === "1" ? "Active" : "Inactive",
                    item.item_image_url || '',
                    item.variation_groupname || '',
                    '', '', '', '', '', '', '' // Empty fields for variation/addon details
                ]);

                // Add variations if they exist for the item
                if (item.itemallowvariation === "1" && item.variation && item.variation.length > 0) {
                    item.variation.forEach(v => {
                        rows.push([
                            restaurantName,
                            categoryName,
                            subCategoryName,
                            item.itemid, // Link to parent item
                            item.itemname, // Link to parent item
                            '', '', '', '', '', // Empty fields for base item details
                            item.variation_groupname,
                            v.id,
                            v.name,
                            v.price,
                            v.active === "1" ? "Active" : "Inactive",
                            '', '', '' // Empty fields for addon group details
                        ]);
                    });
                }

                // Add addons if they exist for the item
                if (item.itemallowaddon === "1" && item.addon && item.addon.length > 0) {
                    item.addon.forEach(addonRef => {
                        const group = addongroupMap.get(addonRef.addon_group_id);
                        if (group && Array.isArray(group.addongroupitems)) {
                            group.addongroupitems.forEach(addonItem => {
                                rows.push([
                                    restaurantName,
                                    categoryName,
                                    subCategoryName,
                                    item.itemid, // Link to parent item
                                    item.itemname, // Link to parent item
                                    '', '', '', '', '', // Empty fields for base item details
                                    '', // Empty for variation group name
                                    addonItem.addonitemid,
                                    addonItem.addonitem_name,
                                    addonItem.addonitem_price,
                                    addonItem.active === "1" ? "Active" : "Inactive",
                                    group.addongroup_name,
                                    addonRef.addon_item_selection_min,
                                    addonRef.addon_item_selection_max
                                ]);
                            });
                        }
                    });
                }
            });

            // Convert rows to CSV format
            const csvContent = rows.map(row =>
                row.map(cell => {
                    const stringCell = (cell === null || cell === undefined) ? '' : String(cell);
                    // Escape double quotes by doubling them, then wrap in quotes
                    return `"${stringCell.replace(/"/g, '""')}"`;
                }).join(',')
            ).join('\n');

            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = 'menu_export.csv';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        function removeFile() {
            jsonData = null;
            dropZone.innerText = 'Drop or browse your JSON file here';
            outputDiv.innerHTML = '';
            fileInput.value = null; // Clear the file input
        }
    </script>
</body>
</html>