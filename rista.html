<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <title>Rista JSON to CSV Converter</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            background-color: #f4f6f8;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            margin: 0;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 0 15px rgba(0,0,0,0.1);
            width: 800px; /* Increased width for more content */
            text-align: center;
        }
        .drop-zone {
            border: 2px dashed #007bff;
            padding: 30px;
            border-radius: 8px;
            color: #007bff;
            margin-bottom: 20px;
            cursor: pointer;
            user-select: none;
            transition: background-color 0.3s;
        }
        .drop-zone:hover {
            background-color: #e6f0ff;
        }
        .btn {
            padding: 10px 20px;
            margin: 10px 5px;
            border: none;
            border-radius: 5px;
            font-size: 16px;
            cursor: pointer;
            user-select: none;
            transition: background-color 0.3s;
        }
        .btn.primary {
            background-color: #007bff;
            color: white;
        }
        .btn.primary:hover {
            background-color: #0056b3;
        }
        .btn.danger {
            background-color: #dc3545;
            color: white;
        }
        .btn.danger:hover {
            background-color: #a71d2a;
        }
        table {
            width: 100%;
            margin-top: 20px;
            border-collapse: collapse;
            font-size: 12px; /* Smaller font for more columns */
            table-layout: fixed; /* Fix table layout for consistent column widths */
        }
        th, td {
            padding: 8px;
            border: 1px solid #ddd;
            text-align: left;
            word-wrap: break-word; /* Ensure long text wraps */
        }
        th {
            background-color: #007bff;
            color: white;
        }
        #output {
            max-height: 400px; /* Limit height of the output table */
            overflow-y: auto; /* Add scrollbar if content overflows */
            margin-top: 20px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h2>ðŸ“„ Rista JSON to CSV Converter</h2>
        <div class="drop-zone" id="dropZone">Drop or browse Rista JSON file here</div>
        <input type="file" id="fileInput" style="display:none" accept=".json" />
        <br />
        <button class="btn primary" onclick="showCategoryStats()">Show Category Stats</button>
        <button class="btn primary" onclick="downloadCSV()">Convert & Download CSV</button>
        <button class="btn danger" onclick="removeFile()">Remove File</button>
        <div id="output"></div>
    </div>

    <script>
        let jsonData = null;
        const dropZone = document.getElementById('dropZone');
        const fileInput = document.getElementById('fileInput');
        const outputDiv = document.getElementById('output');

        dropZone.addEventListener('click', () => fileInput.click());
        dropZone.addEventListener('dragover', (e) => {
            e.preventDefault();
            dropZone.style.backgroundColor = '#e0e0e0';
        });
        dropZone.addEventListener('dragleave', () => {
            dropZone.style.backgroundColor = 'white';
        });
        dropZone.addEventListener('drop', (e) => {
            e.preventDefault();
            dropZone.style.backgroundColor = 'white';
            const file = e.dataTransfer.files[0];
            readFile(file);
        });
        fileInput.addEventListener('change', (e) => {
            const file = e.target.files[0];
            readFile(file);
        });

        function readFile(file) {
            if (!file) return;
            const reader = new FileReader();
            reader.onload = () => {
                try {
                    jsonData = JSON.parse(reader.result);
                    console.log('JSON loaded:', jsonData);
                    dropZone.innerText = `Loaded: ${file.name}`;
                    outputDiv.innerHTML = '';
                } catch (e) {
                    alert('Invalid JSON file. Please upload a valid JSON.');
                    dropZone.innerText = 'Drop or browse Rista JSON file here';
                    jsonData = null;
                    outputDiv.innerHTML = '';
                }
            };
            reader.readAsText(file);
        }

        function getRistaResponseData() {
            if (jsonData && jsonData.log_142697553 && jsonData.log_142697553.response) {
                return jsonData.log_142697553.response;
            }
            return null;
        }

        function getCategories(responseData) {
            return responseData && responseData.categories ? responseData.categories : [];
        }

        function getItems(responseData) {
            return responseData && responseData.items ? responseData.items : [];
        }

        function getItemTags(responseData) {
            return responseData && responseData.itemTags ? responseData.itemTags : [];
        }

        function getOptionSets(responseData) {
            return responseData && responseData.optionSets ? responseData.optionSets : [];
        }

        function showCategoryStats() {
            if (!jsonData) {
                alert('Upload a file first');
                return;
            }

            const responseData = getRistaResponseData();
            if (!responseData) {
                alert('Invalid Rista JSON structure: Missing response data.');
                return;
            }

            const categories = getCategories(responseData);
            const items = getItems(responseData);

            if (!categories.length) {
                alert('No categories found in JSON');
                return;
            }

            const categoryItemCounts = new Map();
            categories.forEach(cat => {
                categoryItemCounts.set(cat.categoryId, { name: cat.name, count: 0 });
                if (cat.subCategories) {
                    cat.subCategories.forEach(subCat => {
                        categoryItemCounts.set(subCat.subCategoryId, { name: `${cat.name} > ${subCat.name}`, count: 0 });
                    });
                }
            });

            items.forEach(item => {
                const categoryId = item.categoryId;
                const subCategoryId = item.subCategoryId;

                if (subCategoryId && categoryItemCounts.has(subCategoryId)) {
                    categoryItemCounts.get(subCategoryId).count++;
                } else if (categoryId && categoryItemCounts.has(categoryId)) {
                    categoryItemCounts.get(categoryId).count++;
                }
            });

            let html = `<table>
                            <tr>
                                <th>Category / Sub-Category</th>
                                <th>Item Count</th>
                            </tr>`;
            let total = 0;

            categoryItemCounts.forEach((data) => {
                html += `<tr><td>${data.name}</td><td>${data.count}</td></tr>`;
                total += data.count;
            });

            html += `<tr><th>Total</th><th>${total}</th></tr></table>`;
            outputDiv.innerHTML = html;
        }

        function downloadCSV() {
            if (!jsonData) {
                alert('Upload a file first');
                return;
            }

            const responseData = getRistaResponseData();
            if (!responseData) {
                alert('Invalid Rista JSON structure: Missing response data.');
                return;
            }

            const categories = getCategories(responseData);
            const items = getItems(responseData);
            const itemTags = getItemTags(responseData);
            const optionSets = getOptionSets(responseData);

            if (!items.length) {
                alert('No items found to export.');
                return;
            }

            // Create maps for quick lookups
            const categoryMap = new Map();
            categories.forEach(cat => {
                categoryMap.set(cat.categoryId, cat.name);
                if (cat.subCategories) {
                    cat.subCategories.forEach(subCat => {
                        categoryMap.set(subCat.subCategoryId, subCat.name);
                    });
                }
            });

            const itemTagMap = new Map();
            itemTags.forEach(tag => {
                itemTagMap.set(tag.itemTagId, tag.name);
            });

            const optionSetMap = new Map();
            optionSets.forEach(os => {
                optionSetMap.set(os.optionSetId, os);
            });

            const rows = [
                ["Item Name", "Item ID", "SKU ID", "Description", "Status", "Category Name", "Sub-Category Name", "Item Tags", "Image URL",
                 "Option Set ID", "Option Set Display Name", "Option Set Min", "Option Set Max",
                 "Option ID", "Option Item ID", "Option Name", "Option Price"]
            ];

            items.forEach(item => {
                const categoryName = categoryMap.get(item.categoryId) || 'N/A';
                const subCategoryName = item.subCategoryId ? categoryMap.get(item.subCategoryId) : categoryName;

                const tags = (item.itemTagIds || []).map(tagId => itemTagMap.get(tagId) || '').filter(name => name !== '').join('; ');

                // Function to escape CSV values
                const escapeCsv = (value) => {
                    if (value === null || value === undefined) {
                        return '';
                    }
                    let stringValue = String(value);
                    // If the value contains a comma, double quote, or newline, enclose it in double quotes
                    // and escape any existing double quotes by doubling them.
                    if (stringValue.includes(',') || stringValue.includes('"') || stringValue.includes('\n')) {
                        return `"${stringValue.replace(/"/g, '""')}"`;
                    }
                    return stringValue;
                };

                // Main item row
                rows.push([
                    escapeCsv(item.itemName),
                    escapeCsv(item.itemId),
                    escapeCsv(item.skuCode),
                    escapeCsv(item.description),
                    escapeCsv(item.status),
                    escapeCsv(categoryName),
                    escapeCsv(subCategoryName),
                    escapeCsv(tags),
                    escapeCsv(item.imageURL),
                    '', '', '', '', // Empty fields for option set details
                    '', '', '', ''   // Empty fields for option details
                ]);

                // Add options/variants if they exist for the item (from optionSetIds mapping)
                if (item.optionSetIds && item.optionSetIds.length > 0) {
                    item.optionSetIds.forEach(osId => {
                        const optionSet = optionSetMap.get(osId);
                        if (optionSet) {
                            const optionSetDisplayName = optionSet.displayName || '';
                            const optionSetMin = optionSet.min !== undefined ? optionSet.min : '';
                            const optionSetMax = optionSet.max !== undefined ? optionSet.max : '';

                            // Add a line for the option set itself
                            rows.push([
                                escapeCsv(item.itemName), // Link to parent item
                                escapeCsv(item.itemId),   // Link to parent item
                                '', '', '', '', '', '', '', // Empty fields for base item details
                                escapeCsv(optionSet.optionSetId),
                                escapeCsv(optionSetDisplayName),
                                escapeCsv(optionSetMin),
                                escapeCsv(optionSetMax),
                                '', '', '', '' // Empty fields for individual option details
                            ]);

                            if (optionSet.options && optionSet.options.length > 0) {
                                optionSet.options.forEach(option => {
                                    rows.push([
                                        escapeCsv(item.itemName), // Link to parent item
                                        escapeCsv(item.itemId),   // Link to parent item
                                        '', '', '', '', '', '', '', // Empty fields for base item details
                                        escapeCsv(optionSet.optionSetId),
                                        escapeCsv(optionSetDisplayName),
                                        escapeCsv(optionSetMin),
                                        escapeCsv(optionSetMax),
                                        escapeCsv(option.optionId),
                                        escapeCsv(option.itemId),
                                        escapeCsv(option.optionName),
                                        escapeCsv(option.price)
                                    ]);
                                });
                            }
                        }
                    });
                }
            });

            // Convert rows to CSV format
            const csvContent = rows.map(row => row.join(',')).join('\n');

            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = 'rista_menu_export.csv';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        function removeFile() {
            jsonData = null;
            dropZone.innerText = 'Drop or browse Rista JSON file here';
            outputDiv.innerHTML = '';
            fileInput.value = null; // Clear the file input
        }
    </script>
</body>
</html>